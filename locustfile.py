from locust import HttpUser, task, between
import random
import os

class RiceClassificationUser(HttpUser):
    wait_time = between(1, 3)

    @task
    def predict(self):
        """Send a POST request to the /predict/ endpoint."""
        test_image_path = "tests/sample_image.jpg"
        
        if not os.path.exists(test_image_path):
            print(f"Error: Test image file '{test_image_path}' does not exist.")
            return
        
        with open(test_image_path, "rb") as img:
            files = {"data": img}
            self.client.post("/predict/", files=files)
    
    @task(2)
    def root(self):
        """Send a GET request to the root endpoint."""
        self.client.get("/")




"""

>> locust -f locustfile.py --headless --users 100 --spawn-rate 10 --run-time 30s --host http://localhost:8089
[2025-01-18 12:42:45,998] DESKTOP-UHS6K67/INFO/locust.main: Starting Locust 2.32.6
[2025-01-18 12:42:46,000] DESKTOP-UHS6K67/INFO/locust.main: Run time limit set to 30 seconds
Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                    0     0(0.00%) |      0       0       0      0 |    0.00        0.00

[2025-01-18 12:42:46,005] DESKTOP-UHS6K67/INFO/locust.runners: Ramping to 100 users at a rate of 10.00 per second
Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                    0     0(0.00%) |      0       0       0      0 |    0.00        0.00

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                    0     0(0.00%) |      0       0       0      0 |    0.00        0.00

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                            15  15(100.00%) |   4076    4068    4117   4100 |    0.00        0.00
POST     /predict/                                                     5   5(100.00%) |   4072    4069    4076   4076 |    0.00        0.00
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                   20  20(100.00%) |   4075    4068    4117   4100 |    0.00        0.00

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                            25  25(100.00%) |   4074    4057    4117   4100 |    1.40        1.40
POST     /predict/                                                    15  15(100.00%) |   4071    4055    4095   4095 |    0.60        0.60
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                   40  40(100.00%) |   4073    4055    4117   4100 |    2.00        2.00

[2025-01-18 12:42:55,067] DESKTOP-UHS6K67/INFO/locust.runners: All users spawned: {"RiceClassificationUser": 100} (100 total users)
Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                            41  41(100.00%) |   4073    4044    4117   4100 |    3.12        3.12
POST     /predict/                                                    23  23(100.00%) |   4072    4033    4095   4095 |    1.88        1.88
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                   64  64(100.00%) |   4073    4033    4117   4100 |    5.00        5.00

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                            60  60(100.00%) |   4071    4044    4117   4100 |    3.67        3.67
POST     /predict/                                                    42  42(100.00%) |   4070    4033    4095   4095 |    1.89        1.89
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                  102 102(100.00%) |   4070    4033    4117   4100 |    5.56        5.56

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                            88  88(100.00%) |   4067    4037    4117   4100 |    5.10        5.10
POST     /predict/                                                    56  56(100.00%) |   4067    4033    4095   4095 |    3.50        3.50
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                  144 144(100.00%) |   4067    4033    4117   4100 |    8.60        8.60

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                           109 109(100.00%) |   4064    4029    4117   4100 |    8.80        8.80
POST     /predict/                                                    62  62(100.00%) |   4066    4033    4095   4095 |    5.60        5.60
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                  171 171(100.00%) |   4065    4029    4117   4100 |   14.40       14.40

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                           132 132(100.00%) |   4063    4029    4117   4100 |    9.00        9.00
POST     /predict/                                                    74  74(100.00%) |   4064    4033    4095   4095 |    5.70        5.70
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                  206 206(100.00%) |   4064    4029    4117   4100 |   14.70       14.70

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                           159 159(100.00%) |   4062    4029    4117   4100 |    9.80        9.80
POST     /predict/                                                    87  87(100.00%) |   4064    4033    4101   4100 |    5.80        5.80
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                  246 246(100.00%) |   4063    4029    4117   4100 |   15.60       15.60

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                           172 172(100.00%) |   4062    4029    4117   4100 |   11.90       11.90
POST     /predict/                                                    93  93(100.00%) |   4064    4033    4101   4100 |    6.40        6.40
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                  265 265(100.00%) |   4063    4029    4117   4100 |   18.30       18.30

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                           195 195(100.00%) |   4062    4029    4117   4100 |   11.10       11.10
POST     /predict/                                                   109 109(100.00%) |   4065    4033    4101   4100 |    5.10        5.10
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                  304 304(100.00%) |   4063    4029    4117   4100 |   16.20       16.20

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                           220 220(100.00%) |   4062    4029    4117   4100 |   10.60       10.60
POST     /predict/                                                   123 123(100.00%) |   4064    4033    4101   4100 |    5.30        5.30
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                  343 343(100.00%) |   4063    4029    4117   4100 |   15.90       15.90

Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                           236 236(100.00%) |   4062    4029    4117   4100 |   11.10       11.10
POST     /predict/                                                   127 127(100.00%) |   4063    4033    4101   4100 |    6.00        6.00
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                  363 363(100.00%) |   4062    4029    4117   4100 |   17.10       17.10

[2025-01-18 12:43:15,413] DESKTOP-UHS6K67/INFO/locust.main: --run-time limit reached, shutting down
[2025-01-18 12:43:15,596] DESKTOP-UHS6K67/INFO/locust.main: Shutting down (exit code 1)
Type     Name                                                     # reqs      # fails |    Avg     Min     Max    Med |   req/s  failures/s
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
GET      /                                                           253 253(100.00%) |   4062    4029    4117   4100 |    8.62        8.62
POST     /predict/                                                   134 134(100.00%) |   4063    4031    4101   4100 |    4.57        4.57
--------|-------------------------------------------------------|-------|-------------|-------|-------|-------|-------|--------|-----------
         Aggregated                                                  387 387(100.00%) |   4062    4029    4117   4100 |   13.19       13.19

Response time percentiles (approximated)
Type     Name                                                             50%    66%    75%    80%    90%    95%    98%    99%  99.9% 99.99%   100% # reqs
--------|-----------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
GET      /                                                               4100   4100   4100   4100   4100   4100   4100   4100   4100   4100   4100    253
POST     /predict/                                                       4100   4100   4100   4100   4100   4100   4100   4100   4100   4100   4100    134
--------|-----------------------------------------------------------|--------|------|------|------|------|------|------|------|------|------|------|------
         Aggregated                                                      4100   4100   4100   4100   4100   4100   4100   4100   4100   4100   4100    387

Error report
# occurrences      Error
------------------|------------------------------------------------------------------------------------------------------------------------
253                GET /: ConnectionRefusedError(10061, '[WinError 10061] No connection could be made because the target machine actively refused it.')
134                POST /predict/: ConnectionRefusedError(10061, '[WinError 10061] No connection could be made because the target machine actively refused it.')
------------------|------------------------------------------------------------------------------------------------------------------------
"""
